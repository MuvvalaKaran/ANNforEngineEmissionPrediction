function [y1,xf1,xf2] = myNeuralNetworkFunction(x1,x2,xi1,xi2)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 06-Oct-2016 20:50:24.
%
% [y1,xf1,xf2] = myNeuralNetworkFunction(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 8xTS matrix, input #1
%   x2 = 3xTS matrix, input #2
%   xi1 = 8x2 matrix, initial 2 delay states for input #1.
%   xi2 = 3x2 matrix, initial 2 delay states for input #2.
% and returns:
%   y1 = 3xTS matrix, output #1
%   xf1 = 8x2 matrix, final 2 delay states for input #1.
%   xf2 = 3x2 matrix, final 2 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1_xoffset = [50.91;17.65;2.52;0.86;4.14;21.57;1.14;20.25];
x1_step1_gain = [0.0408413314274045;0.0265392781316348;0.100654252642174;0.350262697022767;0.0950570342205323;0.0254614894971356;0.0956480153036824;0.0257433389110568];
x1_step1_ymin = -1;

% Input 2
x2_step1_xoffset = [142.13;4.15;68.11];
x2_step1_gain = [0.0223214285714286;0.076103500761035;0.0312842171124668];
x2_step1_ymin = -1;

% Layer 1
b1 = [-14.490515435311872;1.6897080028788651;3.8938776050231168;-4.4232199538201176;2.399262628774089;-1.1217956868577108;-8.0068891023596507;3.7476044035593343;-6.4349460345435689;-0.26959564724224711];
IW1_1 = [1.6950262300022185 2.5797743309099399 -2.1608646818163884 4.8630531311763416 -7.6071367624426269 13.05661806923853 -3.7892480443146788 2.0766213002018059 5.5420221327476566 -5.1016649608728377 -6.5773279371434423 -8.6927811461806961 8.4136505720582058 -3.8787174014849595 -1.0843689846394937 2.1390431724311672;5.803692595500813 1.8792379496441911 3.3643884483930613 1.068696336105158 -0.46451727716317892 -2.05927194630911 -0.56269335887375194 -8.3674325232885352 -3.9849721465807573 -2.8911043528740055 -1.4395748958354293 0.39528493889247462 -2.3714991369197884 -3.8745738537951881 -0.011380062423592019 8.2925578195835303;-6.4405762655889198 -4.8152740363970894 1.4745669572281621 -2.0242217824083601 -2.4812424158682371 2.6652974298953689 5.2287068983668101 -1.9418612386020329 0.20715800161227671 6.624004207789473 2.0966297180434617 1.4413569407145603 -0.7215363596726323 3.1620142500198485 3.1938347286745987 1.4834406765077572;-3.5203967696288192 0.66769868795729204 9.6979824170870614 3.5855913983556902 0.077511530508373783 -7.7752243330753439 -0.87411041991411642 6.1228871521692225 -0.87825372795877077 -3.1460598381041822 3.4470601207086355 -10.042629945938264 14.339688148485543 -13.347311188763788 5.0495931047898699 -10.930795126946347;-3.9167132788337859 0.83552273796227094 3.5164170774140908 0.56408341967357556 -5.2461133066423589 4.1447586722561196 6.3562823476312476 -1.6791063005171318 -3.5602500344294485 -0.3514684490104063 -1.7150505880711429 -5.5459716043504148 3.3693889611375631 -1.1673420731824429 4.5394011401967083 5.9370452490553181;-0.084405218094516732 2.1343884314518813 9.3770932013675079 5.6196970494194929 -5.4503941707147501 3.3099205043581708 -1.5913018988989565 -5.2347746064868561 0.93806672945130898 -2.7776186800924174 -2.6379175806625885 -5.9104625006450258 4.1575698459795971 3.5839912297945027 -2.0889932278397638 -0.33867593317842104;6.3324414724913884 -4.6374665879245702 8.1021233253176881 9.9088495959544431 -12.364945308636777 3.0866313842107416 -8.1521331046292431 -9.6753204309769458 1.7141919093440872 -3.4949550028365861 -3.4157674472120334 -8.4983425075076653 4.887377767918812 0.91882612042793443 0.74240615747395011 -0.11979106506647952;-2.3124397789572986 -0.74103204982685722 1.0600385063014262 -5.4032497492861173 1.2770478659236029 0.76079465087497944 3.7780589186088505 0.98351422683279677 3.2794566198615818 2.5659314059516158 2.1852625632600904 0.52990613009482113 -0.63097695534466125 -4.0166930142471458 -1.6975943094074977 1.4577529867797305;5.1975564480881458 2.1734245186549317 -10.877627681174042 -7.2559022568038118 -0.99498554034620668 -0.95703120495195348 2.5547765461443777 5.3559109848341118 0.60892523443711521 -2.9501345442993143 4.4813022695658731 -8.8913352415969342 0.29733266425338378 0.57251338760657622 -0.58436992014496147 2.9921763623203024;-0.29067731711494066 -0.13547390345679922 -0.077315760948843848 0.27716110002976901 -0.40915151727593779 0.50664202656261759 -0.027513569988627529 0.10804542008131716 0.24192701689157756 -0.0069267296346963714 0.41969174381068652 -0.33988676900289277 0.085808609662333751 -0.38303979515829245 0.09860383151598423 -0.051717199441914261];
IW1_2 = [11.064235025861075 -7.7859370697092967 -9.6771772414837844 4.6598679661843008 -10.311380624478938 10.260040175974495;-11.544878046849625 7.6326232709260591 12.769339336115371 14.632848466716984 -2.6142139071560919 -13.175449485933857;6.5062037904239371 -3.5966777288186038 1.0533483931321457 4.3742407669778505 0.34218536847501646 -5.0194089977734277;-1.9796474524487011 -8.7085435491354417 5.4126092316899417 23.2526219511935 0.63265111157156928 -34.123144079447826;0.3804406835483729 3.2971543002422412 -4.584003210133508 2.7591922003050069 -2.9745447705242256 0.33171632184646715;-5.1241114572848154 0.73904967950155287 1.3613135252175153 -4.6479807563135838 -0.80813789248792145 -5.5588153022715305;-1.0410327635762173 -7.5228398225601643 -4.8755032734234653 4.0746501240102209 -6.7027773602868503 3.9012329671620001;-2.4243346233641274 2.910471529853174 8.0786043504262448 -2.2838889230483357 -2.1283090870393901 4.3673244489777128;9.6619832019963656 -1.0649803110010589 -4.2526240217033076 13.335754068410324 -6.1170590928905471 -0.65139849199351696;0.29130700654267211 0.13419106120900759 -0.30497453942728059 -0.077550001343786923 -0.47600160496054689 1.0429658531329027];

% Layer 2
b2 = [0.0053750139184625539;-0.40951981889316569;-0.036146678013093465];
LW2_1 = [-0.12142535724227084 0.091134910563842542 0.1052572852091074 0.023585881768745185 -0.12959439536579206 0.11842207127198394 -0.099027421139574079 -0.088835313863701484 0.1291400847972336 1.0223349719437431;-0.059140742972347678 0.065901446288748347 0.035548961813892062 -0.0016089549821422227 -0.074375111073173766 0.055558237491473796 -0.11912672945526023 -0.066299096594210585 0.12442837842523108 0.47463663216483332;-0.10223236038654802 0.087514941995811973 0.086146842741157248 -0.0062507035332691023 -0.13813224927378609 0.093218780944988866 -0.059116781013768466 -0.034622990670288595 0.058624725963731222 0.92450480195574025];

% Output 1
y1_step1_ymin = -1;
y1_step1_gain = [0.0223214285714286;0.076103500761035;0.0312842171124668];
y1_step1_xoffset = [142.13;4.15;68.11];

% ===== SIMULATION ========

% Dimensions
TS = size(x1,x2); 
% timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1_gain,x1_step1_xoffset,x1_step1_ymin);
xd1 = [xd1 zeros(8,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1_gain,x2_step1_xoffset,x2_step1_ymin);
xd2 = [xd2 zeros(3,1)];

% Allocate Outputs
y1 = zeros(3,TS);

% Time loop
for ts=1:TS
    
    % Rotating delay state position
    xdts = mod(ts+1,3)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1_gain,x1_step1_xoffset,x1_step1_ymin);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1_gain,x2_step1_xoffset,x2_step1_ymin);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2]-1,3)+1),16,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2]-1,3)+1),6,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1_gain,y1_step1_xoffset,y1_step1_ymin);
end

% Final delay states
finalxts = TS+(1: 2);
xits = finalxts(finalxts<=2);
xts = finalxts(finalxts>2)-2;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings_gain,settings_xoffset,settings_ymin)
y = bsxfun(@minus,x,settings_xoffset);
y = bsxfun(@times,y,settings_gain);
y = bsxfun(@plus,y,settings_ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings_gain,settings_xoffset,settings_ymin)
x = bsxfun(@minus,y,settings_ymin);
x = bsxfun(@rdivide,x,settings_gain);
x = bsxfun(@plus,x,settings_xoffset);
end
